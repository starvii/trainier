{% extends "base/skeleton.html" %}
{% block container %}
    {% raw %}
    <div id="app">
        <div id="take_quiz" v-if="isTaking()">
            <nav class="navbar">
                <div class="navbar-menu">
                    <div class="navbar-item is-expanded">
                        <progress class="progress is-small" value="15" max="100">15%</progress>
                    </div>
                    <div class="navbar-end">
                        <div class="navbar-item">
                            <div class="buttons">
                                <a class="button">交卷</a>
                                <a class="button">退出</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="columns">
                <div class="column is-12">
                    <div class="buttons">
                        <a class="button"
                           v-for="(q, idx) in questionList"
                           v-text="idx+1"
                           @click="switch_to(idx+1)"
                           :class="[idx+1==questionIdx ? 'is-info' : {'is-success':!q.marked&&q.answer.length>0, 'is-focused':q.marked&&q.answer.length==0, 'is-success is-focused':q.marked&&q.answer.length>0}]"
                        ></a>
                    </div>
                </div>
            </div>
            <div class="columns">
                <div class="column is-1">
                    <label class="label">编号</label>
                </div>
                <div class="column is-3">
                    <pre v-text="trunk.code"></pre>
                </div>
                <div class="column is-1">
                    <label class="label">等级</label>
                </div>
                <div class="column is-3">
                    <pre v-text="trunk.level"></pre>
                </div>
                <div class="column is-1">
                    <label class="label">来源</label>
                </div>
                <div class="column is-3">
                    <pre v-text="trunk.source"></pre>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <div class="field" v-if="trunk.en_trunk.length > 0">
                        <label class="label">英文题目</label>
                        <div class="control">
                            <pre v-text="trunk.en_trunk"></pre>
                        </div>
                    </div>
                    <div class="field" v-if="trunk.cn_trunk.length > 0">
                        <label class="label">中文题目</label>
                        <div class="control">
                            <pre v-text="trunk.cn_trunk"></pre>
                        </div>
                    </div>
                </div>
            </div>
            <label v-for="(opt, index) in options" :for="`ABCDEFGHIJKL`[index]">
                <div class="columns" >
                    <div class="column is-2">
                        <input :id="`ABCDEFGHIJKL`[index]" type="checkbox" name="answer" :value="`ABCDEFGHIJKL`[index]"
                               v-model="answer" v-if="opt.multi_choice">
                        <input :id="`ABCDEFGHIJKL`[index]" type="radio" name="answer" :value="`ABCDEFGHIJKL`[index]" v-model="answer" v-else>
                        <span v-text="`ABCDEFGHIJKL`[index] + `.`"></span>
                    </div>
                    <div class="column is-5">
                        <pre v-text="opt.en_option"></pre>
                    </div>
                    <div class="column is-5">
                        <pre v-text="opt.cn_option"></pre>
                    </div>
                </div>
            </label>
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <a class="button" v-bind="{'disabled':questionIdx<=1}">上一题</a>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <a class="button" v-bind="{'disabled':questionIdx>=questionList.length}">下一题</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="select_quiz" v-else>
            <div class="columns">
                <div class="column is-12">
                    <table class="table is-striped is-narrow is-fullwidth is-hoverable">
                        <thead>
                        <tr>
                            <td colspan="5">
                                <page-component :conf.sync="pageConf"></page-component>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <input class="input is-small" type="text" v-model="kw" @keyup.enter="search()">
                            </td>
                            <td><a class="button is-small" title="查找" @click="search()">
                                <i class="fas fa-search"></i>
                            </a></td>
                        </tr>
                        <tr>
                            <th>编号</th>
                            <th>编码</th>
                            <th>名称</th>
                            <th>数量</th>
                            <th>开始</th>
                        </tr>
                        </thead>
                        <tfoot>
                        <tr>
                            <td colspan="5">
                                <page-component :conf.sync="pageConf"></page-component>
                            </td>
                        </tr>
                        </tfoot>
                        <tbody>
                        <tr v-for="(item, idx) in data">
                            <td>
                                <a :href="`/quiz/view#` + item.entity_id"
                                   target="_blank"
                                   v-text="(pageConf.currentPage - 1) * pageConf.itemsPerPage + idx + 1"
                                   :title="item.comment"></a>
                            </td>
                            <td>
                                <a :href="`/quiz/view#` + item.entity_id" target="_blank" v-text="item.code"
                                   :title="item.comment"></a>
                            </td>
                            <td>
                                <a :href="`/quiz/view#` + item.entity_id" target="_blank" v-text="item.name"
                                   :title="item.comment"></a>
                            </td>
                            <td>
                                <a :href="`/quiz/view#` + item.entity_id" target="_blank" v-text="item.count"
                                   :title="item.comment"></a>
                            </td>
                            <td>
                                <div class="buttons has-addons">
                                    <a class="button is-small" title="开始测验" @click="start(item.entity_id)">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="footer has-background-white"></footer>
    </div>
    {% endraw %}
{% endblock %}
{% block script %}
    {% raw %}
    <script src="/js/common.js"></script>
    <script src="/js/page.js"></script>
    <script>
        const app = new window.Vue({
            el: '#app',
            data: {
                data: [],
                pageConf: {
                    currentPage: 1,
                    totalItems: 1000,
                    itemsPerPage: 10,
                    pagesLength: 9,
                    perPageOptions: [10, 15, 30, 50, 100],
                    onChange: 'listQuiz',
                },
                keyword: '',
                kw: '',
                questionList: [],
                questionIdx: 1,
                answer: [],
                marked: false,
                trunk: {
                    code: 'code',
                    level: 'level',
                    source: 'source',
                    en_trunk: 'en_trunk',
                    cn_trunk: 'cn_trunk',
                },
                options: [],
            },
            mounted: function () {
                if (this.isTaking()) {
                    this.switch_to(0);
                }
            },
            methods: {
                isTaking: function () {
                    let quiz = getCookie('quiz');
                    return quiz !== null;
                },
                listQuiz: function () {
                    axios({
                        method: 'POST',
                        url: '/quiz/api/',
                        data: {
                            page: this.pageConf.currentPage,
                            size: this.pageConf.itemsPerPage,
                            keyword: this.keyword,
                        },
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK') {
                                let t = response.data;
                                this.pageConf.currentPage = t.page;
                                this.pageConf.totalItems = t.total;
                                this.pageConf.itemsPerPage = t.size;
                                this.data = t.data;
                            } else {
                                alert('请求服务失败，请检查日志');
                            }

                        }.bind(this)).catch(
                        function (error) {
                            alert('请求服务失败，请检查日志。' + error);
                        }
                    );
                },
                start: function (quizId) {
                    axios({
                        method: 'GET',
                        url: '/quiz/take/api/' + quizId,
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK' && response.data.result === true) {
                                // 设置cookie完成
                                if (this.isTaking()) {
                                    window.location.reload();
                                }
                            } else {
                                alert('请求服务失败，请检查日志');
                            }
                        }.bind(this)).catch(
                        function (error) {
                            alert('请求服务失败，请检查日志。' + error);
                        }
                    );
                },
                switch_to: function (switchIdx) {
                    if (switchIdx < 1) {
                        this.questionIdx = 1;
                    } else if (switchIdx > this.questionList.length) {
                        this.questionIdx = this.questionList.length;
                    } else {
                        this.questionIdx = switchIdx;
                    }
                    let answer = this.answer;
                    if (typeof this.answer === 'string') {
                        answer = [this.answer];
                    }
                    let postData = {
                        idx: this.questionIdx,
                        answer: answer,
                        marked: this.marked,
                    };
                    axios({
                        method: 'POST',
                        url: '/quiz/take/api/' + switchIdx,
                        data: postData,
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK') {
                                this.questionList = response.data['question_list'];
                                this.trunk = response.data['trunk'];
                                this.options = response.data['options'];
                            } else {
                                alert('请求服务失败，请检查日志');
                            }
                        }.bind(this)).catch(
                        function (error) {
                            alert('请求服务失败，请检查日志。' + error);
                        }
                    );
                },
            },
        });
    </script>
    {% endraw %}
{% endblock %}
