{% extends "base/base.html" %}
{% whitespace all %}
{% block body %}
    <div class="container py-4" id="app">
        <div class="btn-group float-right">
            <a class="btn btn-primary btn-sm" href="javascript:window.opener=null;window.open('','_self');window.close();">确定</a>
            <a class="btn btn-warning btn-sm" :href="`edit.html?id=`+quiz.entity_id">编辑</a>
            <a class="btn btn-success btn-sm" :href="`take/?id=`+quiz.entity_id">测验</a>
{#            <a class="btn btn-sm btn-info" :class="{'disabled':prevId.length==0}" :href="`view.html?id=`+prevId"><i class="fas fa-angle-left"></i></a>#}
{#            <a class="btn btn-sm btn-info" :class="{'disabled':nextId.length==0}" :href="`view.html?id=`+nextId"><i class="fas fa-angle-right"></i></a>#}
        </div>
        <form class="form-inline pb-3">
            <div class="form-group">
                <label>测验编号</label>
                <pre class="mx-sm-3" v-text="quiz.code"></pre>
            </div>
            <div class="form-group">
                <label>测验名称</label>
                <pre class="mx-sm-3" v-text="quiz.name"></pre>
            </div>
            <div class="form-check px-sm-2">
                <input class="form-check-input" disabled="disabled" type="checkbox" id="random_trunk" title="题目前后有关联的情况下不建议开启" v-model="quiz.random_trunk">
                <label class="form-check-label" for="random_trunk" title="题目前后有关联的情况下不建议开启">
                    随机题目顺序
                </label>
            </div>
            <div class="form-check px-sm-2">
                <input class="form-check-input" disabled="disabled" type="checkbox" id="random_choice" title="选项前后有有序的情况下不建议开启" v-model="quiz.random_choice">
                <label class="form-check-label" for="random_choice" title="选项前后有有序的情况下不建议开启">
                    随机选项顺序
                </label>
            </div>
        </form>
        <form v-if="quiz.comment&&quiz.comment.length>0">
            <div class="form-group">
                <label for="comment">备注</label>
                <pre v-text="quiz.comment"></pre>
            </div>
        </form>

        <div class="row">
            <table class="table table-striped table-bordered table-sm">
                <thead>
                    <tr>
                        <td colspan="4">
                            <page-component ref="pageComponent" :conf.sync="pageConf" @onchange="list"></page-component>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            <div class="input-group">
                                <input class="form-control form-control-sm" type="text" v-model="kwBind" @keyup.enter="search()">
                                <div class="input-group-append">
                                    <a class="btn btn-sm btn-outline-secondary" title="查找" @click="search()">
                                        <i class="fas fa-search"></i>
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>序号</th>
                        <th>编号</th>
                        <th>题目（英文）</th>
                        <th>题目（中文）</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <td colspan="4">
                            <page-component :conf.sync="pageConf" @onchange="list"></page-component>
                        </td>
                    </tr>
                </tfoot>
                <tbody>
                    <tr v-for="(item, idx) in trunks">
                        <td>
                            <a :href="`view.html?id=` + item.entity_id" target="_blank" v-text="(pageConf.currentPage - 1) * pageConf.itemsPerPage + idx + 1"></a>
                        </td>
                        <td>
                            <a :href="`view.html?id=` + item.entity_id" target="_blank" v-text="item.code"></a>
                        </td>
                        <td colspan="2" v-if="item.x_trunk.length > 0">
                            <a :href="`view.html?id=` + item.entity_id" target="_blank" :title="item.x_trunk" v-text="item.x_trunk_digest"></a>
                        </td>
                        <td v-if="item.x_trunk.length == 0">
                            <a :href="`view.html?id=` + item.entity_id" target="_blank" :title="item.en_trunk" v-text="item.en_trunk_digest"></a>
                        </td>
                        <td v-if="item.x_trunk.length == 0">
                            <a :href="`view.html?id=` + item.entity_id" target="_blank" :title="item.cn_trunk" v-text="item.cn_trunk_digest"></a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% end %}
{% block script %}
    <script src="/js/page.js"></script>
    <script src="/js/common.js"></script>
    <script type="text/javascript">
        window.app = new window.Vue({
            el: '#app',
            data: {
                quiz: {},
                trunks: [],
                selectAll: true,
                onlyShowSelected: true,
                selLst: [],
                pageConf: {
                    currentPage: 1,
                    totalItems: 0,
                    itemsPerPage: 10,
                    pagesLength: 9,
                    perPageOptions: [10, 15, 30, 50, 100],
                },
                keyword: '',
                kwBind: '',
            },
            mounted() {
                this.quiz.entity_id = getUrlParam('id');
                this.load();
            },
            methods: {
                initSync() {
                    this.selLst = [];
                    for (let s0 of this.quiz.questions) {
                        let s1 = s0.trim();
                        if (s1.length > 0) {
                            this.selLst.push(s1);
                        }
                    }
                    this.list()
                },
                load() {
                    axios({
                        url: '/api/quiz/' + this.quiz.entity_id,
                        method: 'GET',
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK' && response.data.result) {
                                console.debug(response.data);
                                this.quiz = response.data.quiz;
                                this.initSync();
                            } else {
                                alert('请求失败，请检查日志');
                            }
                        }.bind(this)
                    ).catch(
                        (error) => {
                            alert('请求失败，请检查日志。' + error);
                        }
                    );
                },
                list(uid) {
                    if (typeof uid !== 'undefined' && uid !== this.$refs.pageComponent._uid) {
                        this.$refs.pageComponent.
                        return;
                    }
                    let data = {
                        page: this.pageConf.currentPage,
                        size: this.pageConf.itemsPerPage,
                        keyword: this.keyword,
                        ids: this.selLst,
                    };
                    axios({
                        method: 'POST',
                        url: '/api/question/',
                        data: data,
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK' && response.data.result) {
                                let t = response.data;
                                // 进行简化处理
                                let trunks = t.trunks;
                                digest(trunks);
                                // 分页器赋值
                                this.trunks = trunks;
                                this.pageConf.totalItems = t.count;
                            } else {
                                alert('请求服务失败，请检查日志');
                            }

                        }.bind(this)).catch(
                        (error) => {
                            alert('请求服务失败，请检查日志。' + error);
                        }
                    );
                },
                search() {
                    if (this.keyword !== this.kwBind.trim()) {
                        this.keyword = this.kwBind.trim();
                        this.list();
                    }
                },
            },
        });
    </script>
{% end %}
