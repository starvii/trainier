{#
    single trunk:
        code, level
        en_trunk
        cn_trunk
        (options)
        (explanation)
        source, comment

    parent trunk:
        code, level
        en_trunk
        cn_trunk
        source, comment
    child trunk:
        en_trunk
        cn_trunk
        options
        explanation
        comment
#}

{% extends "base/base.html" %}
{% whitespace all %}
{% block body %}
    <div class="container py-4" id="app">
        <button type="button" class="btn btn-primary btn-sm float-right" @click="save()">保存</button>
        <form class="form-inline pb-3">
            <div class="form-group">
                <label>编号</label>
                <input type="text" class="form-control form-control-sm mx-sm-3" id="trunk_code" placeholder="编号" v-model="trunk.code">
            </div>
            <div class="form-group">
                <label>等级</label>
                <input type="text" class="form-control form-control-sm mx-sm-3" id="trunk_level" placeholder="等级" v-model="trunk.level">
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="has_children" title="如果主题干下有数个小题，请勾选此处" v-model="hasTrunkChild">
                <label class="form-check-label" for="has_children" title="如果主题干下有数个小题，请勾选此处">
                    包含子题
                </label>
            </div>
        </form>
        <form>
            <div class="form-group">
                <label for="en_trunk">英文题目</label>
                <ckeditor id="en_trunk" type="classic" v-model="trunk.en_trunk" :config="config" :upload-adapter="uploadAdapter"></ckeditor>
            </div>
            <div class="form-group">
                <label for="cn_trunk">中文题目</label>
                <ckeditor id="cn_trunk" type="classic" v-model="trunk.cn_trunk" :config="config" :upload-adapter="uploadAdapter"></ckeditor>
            </div>

            <div v-if="!hasTrunkChild">
                <options-component :options.sync="trunk.options"></options-component>

                <div class="form-group">
                    <label for="explanation">详解</label>
                    <textarea id="explanation" class="form-control form-control-sm" rows="5" v-model="trunk.explanation"></textarea>
                </div>
            </div>

            <div class="form-row">
                    <div class="col">
                        <label for="source">来源</label>
                        <textarea id="source" class="form-control form-control-sm" rows="3" v-model="trunk.source"></textarea>
                    </div>
                <div class="col">
                        <label for="comment">备注</label>
                        <textarea id="comment" class="form-control form-control-sm" rows="3" v-model="trunk.comment"></textarea>
                    </div>
            </div>

            <trunks-component :trunks.sync="trunkChildren" v-if="hasTrunkChild"></trunks-component>
        </form>
    </div>
{% end %}
{% block script %}
    <script type="text/javascript" src="/js/common.js"></script>
    <script type="text/javascript" src="/ckeditor/classic/ckeditor.js"></script>
    <script type="text/javascript" src="/ckeditor/vue-ckeditor5.js"></script>
    <script type="text/javascript" src="/js/options.js"></script>
    <script type="text/javascript" src="/js/subtrunk.js"></script>
    <script type="text/javascript" src="/js/subtrunks.js"></script>
    <script type="text/javascript">
        window.Vue.use(VueCkeditor.plugin, {
            editors: {
                classic: ClassicEditor,
              },
              name: 'ckeditor'
        });
        window.app = new window.Vue({
            el: '#app',
            data: {
                hasTrunkChild: false,
                trunkId: '',
                trunk: newTrunk(),
                trunkChildren: [newTrunk()],
                config: ckeditorConfig,
                uploadAdapter: CkeditorUploadAdapter,
            },
            mounted() {
                let id = getUrlParam('id');
                if (id !== null) {
                    this.trunkId = id;
                    this.load();
                }
            },
            methods: {
                load() {
                    axios({
                        url: `/api/question/${this.trunkId}`,//'/question/api/' + this.trunkId,
                        method: 'GET',
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK' && response.data.result) {
                                this.trunk = response.data.trunk;
                                if (typeof this.trunk.trunks === 'undefined') {
                                    this.hasTrunkChild = false;
                                } else {
                                    this.hasTrunkChild = true;
                                    this.trunkChildren = this.trunk.trunks;
                                }
                            } else {
                                alert('请求失败，请检查日志');
                            }
                        }.bind(this)
                    ).catch(
                        error => {
                            alert('请求失败，请检查日志。' + error);
                        }
                    );
                },
                save() {
                    let trunk = null;
                    if (this.hasTrunkChild) {
                        let parentCode = this.trunk.code;
                        let trunkChildren = [];
                        for (let i = 0; i < this.trunkChildren.length; i++) {
                            let t = this.trunkChildren[i];
                            let trunkChild = {
                                entity_id: t.entity_id,
                                code: `${parentCode}-${i + 1}`,
                                en_trunk: t.en_trunk,
                                cn_trunk: t.cn_trunk,
                                explanation: t.explanation,
                                comment: t. comment,
                                options: t.options,
                            };
                            trunkChildren.push(trunkChild);
                        }
                        trunk = {
                            entity_id: this.trunk.entity_id,
                            code: this.trunk.code,
                            en_trunk: this.trunk.en_trunk,
                            cn_trunk: this.trunk.cn_trunk,
                            level: this.trunk.level,
                            comment: this.trunk.comment,
                            source: this.trunk.source,
                            trunks: trunkChildren,
                        };
                    } else {
                        trunk = {
                            entity_id: this.trunk.entity_id,
                            code: this.trunk.code,
                            en_trunk: this.trunk.en_trunk,
                            cn_trunk: this.trunk.cn_trunk,
                            explanation: this.trunk.explanation,
                            level: this.trunk.level,
                            comment: this.trunk.comment,
                            order_num: this.trunk.order_num,
                            source: this.trunk.source,
                            parent_id: '',
                            options: this.trunk.options,
                        };
                    }
                    axios({
                        url: `/api/question/${this.trunkId}`,
                        method: 'PUT',
                        data: {
                            trunk: trunk,
                        },
                    }).then(function (response) {
                        if (response.status === 200 && response.statusText === 'OK' && response.data.result) {
                            alert('保存成功');
                            //window.location.href = './';
                            window.opener=null;window.open('','_self');window.close();
                        } else {
                            alert('保存失败，请检查日志');
                        }
                    }.bind(this)).catch(
                        error => {
                            alert('保存失败，请检查日志。' + error);
                        }
                    );
                },
            },
        });
    </script>
{% end %}
