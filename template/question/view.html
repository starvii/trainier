{% extends "base/base.html" %}
{% whitespace all %}
{% block body %}
    <div class="container py-3" id="app" v-if="trunkId!=null&&trunk!=null">
        <div class="btn-group float-right">
            <a class="btn btn-primary btn-sm" href="javascript:window.opener=null;window.open('','_self');window.close();">确定</a>
            <a class="btn btn-warning btn-sm" :href="`edit.html?id=`+trunkId">编辑</a>
            <a class="btn btn-sm btn-info" :class="{'disabled':prevId.length==0}" :href="`view.html?id=`+prevId"><i class="fas fa-angle-left"></i></a>
            <a class="btn btn-sm btn-info" :class="{'disabled':nextId.length==0}" :href="`view.html?id=`+nextId"><i class="fas fa-angle-right"></i></a>
        </div>

        <form class="form-inline pb-3">
            <div class="form-group">
                <label>题目编号</label>
                <pre class="mx-sm-3" v-text="trunk.code"></pre>
            </div>
            <div class="form-group">
                <label>重要程度</label>
                <pre class="mx-sm-3" v-text="trunk.level"></pre>
            </div>
            <div class="form-check">
                <input class="form-check-input" disabled="disabled" type="checkbox" id="has_children" title="如果主题干下有数个小题，请勾选此处" v-model="hasTrunkChild">
                <label class="form-check-label" for="has_children" title="如果主题干下有数个小题，请勾选此处">
                    包含子题
                </label>
            </div>
        </form>
        <form>
            <div class="form-group" v-if="trunk.en_trunk_len>0">
                <label for="en_trunk">英文题目</label>
                <ckeditor id="en_trunk" type="classic" v-model="trunk.en_trunk" :config="config" :readonly="config.readonly"></ckeditor>
            </div>
            <div class="form-group" v-if="trunk.cn_trunk_len>0">
                <label for="cn_trunk">中文题目</label>
                <ckeditor id="cn_trunk" type="classic" v-model="trunk.cn_trunk" :config="config" :readonly="config.readonly"></ckeditor>
            </div>

            {# 选项 #}

            <div v-if="!hasTrunkChild">
                <div class="form-row" v-for="(option, index) in trunk.options" style="padding-bottom: 7px;">
                    <div class="col justify-content-between">
                        <span>
                            <i class="fas fa-check-circle text-success" v-if="option.is_true"></i>
                            <i class="fas fa-times-circle text-danger" v-else></i>
                        </span>
                        <label class="float-right" v-text="`ABCDEFGHIJKL`[index] + `.`"></label>
                    </div>
                    <div class="col-6" v-if="option.x_option.length==0">
                        <pre v-text="option.en_option"></pre>
                    </div>
                    <div class="col-5" v-if="option.x_option.length==0">
                        <pre v-text="option.cn_option"></pre>
                    </div>
                    <div class="col-11" v-else>
                        <pre v-text="option.x_option"></pre>
                    </div>
                </div>

                <div class="form-group" v-if="trunk.explanation.length>0">
                    <label>详解</label>
                    <pre v-text="trunk.explanation"></pre>
                </div>
            </div>

            <div class="form-group" v-if="trunk.source.length>0">
                <label>来源</label>
                <pre v-text="trunk.source"></pre>
            </div>
            <div class="form-group" v-if="trunk.comment.length>0">
                <label>备注</label>
                <pre v-text="trunk.comment"></pre>
            </div>

            {# 子题目 #}

            <div v-if="hasTrunkChild">
                <div v-for="(trunkChild, index) in trunkChildren">
                    <hr/>
                    <div class="row">
                        <strong class="col" v-text="`第` + (index + 1) + `题`"></strong>
                    </div>
                    <div class="form-group" v-if="trunkChild.en_trunk_len>0">
                        <label>英文题目</label>
                        <ckeditor type="classic" v-model="trunkChild.en_trunk" :config="config" :readonly="config.readonly"></ckeditor>
                    </div>
                    <div class="form-group" v-if="trunkChild.cn_trunk_len>0">
                        <label>中文题目</label>
                        <ckeditor type="classic" v-model="trunkChild.cn_trunk" :config="config" :readonly="config.readonly"></ckeditor>
                    </div>
                    <div class="form-row" v-for="(option, index) in trunkChild.options" style="padding-bottom: 7px;">
                        <div class="col justify-content-between">
                            <span>
                                <i class="fas fa-check-circle text-success" v-if="option.is_true"></i>
                                <i class="fas fa-times-circle text-danger" v-else></i>
                            </span>
                            <label class="float-right" v-text="`ABCDEFGHIJKL`[index] + `.`"></label>
                        </div>
                        <div class="col-6" v-if="option.x_option.length==0">
                            <pre v-text="option.en_option"></pre>
                        </div>
                        <div class="col-5" v-if="option.x_option.length==0">
                            <pre v-text="option.cn_option"></pre>
                        </div>
                        <div class="col-11" v-else>
                            <pre v-text="option.x_option"></pre>
                        </div>
                    </div>
                    <div class="form-group" v-if="trunkChild.explanation.length>0">
                        <label>详解</label>
                        <pre v-text="trunkChild.explanation"></pre>
                    </div>
                    <div class="form-group" v-if="trunkChild.comment.length>0">
                        <label>备注</label>
                        <pre v-text="trunkChild.comment"></pre>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% end %}
{% block script %}
    <script src="/js/common.js"></script>
    <script type="text/javascript" src="/ckeditor/classic/ckeditor.js"></script>
    <script type="text/javascript" src="/ckeditor/vue-ckeditor5.js"></script>
    <script type="text/javascript">
        window.Vue.use(VueCkeditor.plugin, {
            editors: {
                classic: ClassicEditor,
            },
            name: 'ckeditor'
        });
        window.app = new window.Vue({
            el: '#app',
            data: {
                trunkId: '',
                nextId: '',
                prevId: '',
                hasTrunkChild: false,
                trunk: null,
                trunkChildren: null,
                config: {
                    toolbar: [],
                    readonly: true,
                },
            },
            created() {
                this.trunkId = getUrlParam('id');
            },
            mounted() {
                if (this.trunkId !== null) {
                    this.load();
                }
            },
            methods: {
                load() {
                    axios({
                        url: `/api/question/${this.trunkId}`,
                        method: 'GET',
                    }).then(
                        function (response) {
                            if (response.status === 200 && response.statusText === 'OK' && response.data.result) {
                                this.trunk = response.data.trunk;
                                this.nextId = response.data['next'];
                                this.prevId = response.data['prev'];
                                if (typeof this.trunk.trunks === 'undefined') {
                                    this.hasTrunkChild = false;
                                    mergeOptions(this.trunk.options);
                                } else {
                                    this.hasTrunkChild = true;
                                    this.trunkChildren = this.trunk.trunks;
                                    for (let t of this.trunkChildren) {
                                        mergeOptions(t.options)
                                    }
                                }
                            } else {
                                alert('请求失败，请检查日志');
                            }
                        }.bind(this)
                    ).catch(
                        error => {
                            alert('请求失败，请检查日志。' + error);
                        }
                    );
                },
                nextTrunk() {
                    if (this.nextId.length === 0) {
                        alert('no next trunk.');
                    } else {
                        window.location.href = `view.html?id=${this.nextId}`;
                    }
                },
                prevTrunk() {
                    if (this.prevId.length === 0) {
                        alert('no prev trunk.');
                    } else {
                        window.location.href = `view.html?id=${this.prevId}`;
                    }
                },
                ok() {
                    window.opener=null;window.open('','_self');window.close();
                },
                edit() {
                    window.location.href = `edit.html?id=${this.trunkId}`;
                },
            },
        });
    </script>
{% end %}
